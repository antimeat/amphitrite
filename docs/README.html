<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Amphitrite</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: 1;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="github-markdown.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Amphitrite</h1>
</header>
<p>Amphitrite is designed for processing and partitioning wave spectrum
data. Utilizing data from Auswave, with a view to incorporate SWAN model
output in the future. Amphitrite creates bespoke swell partitions based
on specified period ranges.</p>
<h2 id="features">Features</h2>
<hr />
<ul>
<li><strong>Dashboard</strong>: GUI for maintaining configuration,
monitoring logs and manual activation of scripts (see
<a href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/html/dashboard.php" target="_blank">dashboard</a>).</li>
<li><strong>Partition Splitting</strong>: Splits wave spectrum data into
specified swell partitions.</li>
<li><strong>Customizable Configurations</strong>: Users can define their
own partition ranges and site configurations.</li>
<li><strong>Automated Execution</strong>: Configured to run
automatically as a cron job for regular processing.</li>
<li><strong>Frontend API</strong>: Provides an API endpoint for easy
access to processed data.</li>
<li><strong>Backend Database</strong>: Archives data for past 7 days of
model runs.</li>
</ul>
<h2 id="trouble-shooting">Trouble shooting</h2>
<hr />
<ol type="1">
<li><a href="#logging">check the log</a></li>
<li><a href="#running-the-script-from-the-dashboard">run manually from
dashboard</a></li>
<li><a href="#auswave-files">check auswave files</a></li>
<li><a href="#running-the-script-manually">run manually from
terminal</a></li>
</ol>
<h2 id="frontend-dashboard">Frontend Dashboard</h2>
<hr />
<p>Amphitrite features a frontend
<a href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/html/dashboard.php" target="_blank">dashboard</a>
for managing site configurations and manually activating the partition
splitting scripts.</p>
<h3 id="dashboard-features">Dashboard Features</h3>
<ul>
<li><strong>Site data</strong>: API access to interogate current and
recent data.</li>
<li><strong>Site Configuration</strong>: Manage and update the
configuration of various sites, including setting up partition
ranges.</li>
<li><strong>Manual Script Activation</strong>: Trigger the
<code>partitionSplitter.py</code> script directly from the dashboard for
immediate data processing.</li>
<li><strong>Logging</strong>: Inspect log files</li>
</ul>
<h3 id="autoseas">Autoseas</h3>
<p>API and package for calculating and returning autoseas swell data
from winds and partitioned data. More detailed information is here (see
<a href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/docs/README_AUTOSEAS.html" target="_blank">README_AUTOSEAS</a>).</p>
<h2 id="backend-details">Backend details</h2>
<hr />
<h3 id="file-descriptions">File Descriptions</h3>
<p><strong>api.cgi</strong>:</p>
<ul>
<li>CGI script for the API. More details in the <a
href="#api">API</a>.</li>
</ul>
<p><strong>autoseas/</strong>:</p>
<ul>
<li>A package for calculating and returning swell data from winds and
partitioned data. Interfaces through <code>autoseas.cgi</code>. Further
details are in the <a href="#autoseas">AutoSeas section</a>.</li>
</ul>
<p><strong>database.py</strong>:</p>
<ul>
<li>Provides backend database functions and interface.</li>
</ul>
<p><strong>data.py</strong>:</p>
<ul>
<li>Utility functions for managing data.</li>
</ul>
<p><strong>docs/</strong>:</p>
<ul>
<li>Home of the README documentation and script/css for rendering to
html</li>
</ul>
<p><strong>emails.py</strong>:</p>
<ul>
<li>Functionality for an alert email to be sent once a new model run
arrives and the partition splitting is complete.</li>
</ul>
<p><strong>gfe.py</strong>:</p>
<ul>
<li>A function to retrieve point data from GFE.</li>
</ul>
<p><strong>html/</strong>:</p>
<ul>
<li>Contains the frontend dashboard for the package. More details can be
found in the <a href="#frontend-dashboard">Frontend Dashboard
section</a>.</li>
</ul>
<p><strong>autoseas.cgi</strong>:</p>
<ul>
<li>CGI script for the AutoSeas interface. See <a
href="#autoseas">AutoSeas section</a> for more information.</li>
</ul>
<p><strong>models.py</strong>:</p>
<ul>
<li>Contains descriptions of the database models.</li>
</ul>
<p><strong>partition.py</strong>:</p>
<ul>
<li>A class for managing wave partitions and format.</li>
</ul>
<p><strong>partitionSplitter.py</strong>:</p>
<ul>
<li><p>This is the main script that calls other partitioning scripts. It
includes a <code>PartitionSplitter</code> class with methods to handle
wave spectra data, transform it into different formats, and
integrate/interact with the database.</p>
<h3 id="running-the-script-from-the-dashboard">Running the script from
the dashboard</h3>
<p><a href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/html/dashboard.php" target="_blank">go-to
dashboard</a> -&gt; Activate run</p>
<h3 id="running-the-script-manually">Running the script manually</h3>
<p>You can run the script manually (it is automatically scheduled to run
using a cron job).</p>
<p>Manual execution:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> wa-vw-er</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /cws/op/webapps/er_ml_projects/davink/amphitrite</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate mlenv</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> partitionSplitter.py <span class="at">--site</span> [site_name<span class="kw">|</span><span class="ex">all]</span></span></code></pre></div></li>
</ul>
<p><strong>partition_smusher.py</strong>:</p>
<ul>
<li>A class designed to combine spectral data with AutoSeas data.</li>
</ul>
<p><strong>readSpectrum.py</strong>:</p>
<ul>
<li>Backend script for partitioning wave spectra files.</li>
</ul>
<p><strong>save_config.py</strong>:</p>
<ul>
<li>Used to update file <code>table_config.txt</code> and save to
database (configuration file used for swell partitioning)</li>
</ul>
<p><strong>save_exclusions.py</strong>:</p>
<ul>
<li>Used by <a href="#api">API</a> and <a
href="#frontend-dashboard">dashboard</a> to configure the active sites
to exclude from swell partitioning checks</li>
</ul>
<p><strong>sites.py</strong>:</p>
<ul>
<li>Used by <a href="#api">API</a> to get the current active sites.</li>
</ul>
<p><strong>sites_api.cgi</strong>:</p>
<ul>
<li>Manages site-specific API interactions. See <a
href="#sites-api">Sites API</a> for more information.</li>
</ul>
<p><strong>table_config.txt</strong>:</p>
<ul>
<li>The config file used by <a href="#api">API</a> and <a
href="#frontend-dashboard">dashboard</a> for swell partitioning</li>
</ul>
<p><strong>update_sites.py</strong>:</p>
<ul>
<li>Utility functions for initializing or updating the database. Used by
save_config.py</li>
</ul>
<p><strong>watchdog.sh</strong>:</p>
<ul>
<li>A shell script for monitoring the last run time of the cron job.
Refer to <a href="#cron">Cron section</a> for more details.</li>
</ul>
<p><strong>waves_data.db</strong>:</p>
<ul>
<li>sqlite3 database used for storing the wave partitioned data (for up
to 7 days).</li>
</ul>
<h3 id="cron">Cron:</h3>
<p>Currently run under user <code>davink</code> on server:
<code>wa-vw-er</code> The script is set up to run every 3 minutes for 2
hours staring at 5:00AM, 9:00AM, 5:30PM and 9:00PM WST. A lock file
(<code>.lockfile.lock</code>) and log file
(<code>script_errors.log</code>) are used for checking if the script is
already running and logging errors respectively. This should ensure
regular/consistent data processing to begin within 5 minutes of data
arriving. As of <code>25/01/2024</code> Auswave data files have been
arriving at approximately 5:20AM, 9:20AM, 5:20PM and 9:20PM WST.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">###########################</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#scripts to run wave partitioning. check for new models every 3 minutes over a 2 hour period</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">###########################</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">*/3</span> 5-6 <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> cd /cws/op/webapps/er_ml_projects/davink/amphitrite <span class="kw">&amp;&amp;</span> <span class="ex">/cws/op/webapps/er_ml_projects/davink/amphitrite/watchdog.sh</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">*/3</span> 9-10 <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> cd /cws/op/webapps/er_ml_projects/davink/amphitrite <span class="kw">&amp;&amp;</span> <span class="ex">/cws/op/webapps/er_ml_projects/davink/amphitrite/watchdog.sh</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">*/3</span> 17-18 <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> cd /cws/op/webapps/er_ml_projects/davink/amphitrite <span class="kw">&amp;&amp;</span> <span class="ex">/cws/op/webapps/er_ml_projects/davink/amphitrite/watchdog.sh</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ex">*/3</span> 9-10 <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> cd /cws/op/webapps/er_ml_projects/davink/amphitrite <span class="kw">&amp;&amp;</span> <span class="ex">/cws/op/webapps/er_ml_projects/davink/amphitrite/watchdog.sh</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">############################</span></span></code></pre></div>
<h3 id="auswave-files">Auswave files</h3>
<p>The partition splitter relies on the timely arrival of the Auswave
data files and a cron job to start the paritioning process (see <a
href="#cron">cron</a> for more details). The Auswave files arrive on
server <code>wa-vw-er</code> here:
<code>/cws/data/wavewatch/</code>.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> wa-vw-er</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /cws/data/wavewatch/</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span></span></code></pre></div>
<pre><code>drwxr-xr-x.  2 cwsop cwsop      4096 Jan 25 09:20 .
drwxr-xr-x. 18 cwsop cwsop      4096 Jul 25  2023 ..
-rw-rw-r--.  1 cwsop cwsop  52309922 Jan 18 10:50 IDY35050_G3_2024011718.nc
-rw-rw-r--.  1 cwsop cwsop 165489628 Jan 18 17:20 IDY35050_G3_2024011800.nc
-rw-rw-r--.  1 cwsop cwsop  52298564 Jan 18 21:20 IDY35050_G3_2024011806.nc
-rw-rw-r--.  1 cwsop cwsop 165494747 Jan 19 05:20 IDY35050_G3_2024011812.nc
-rw-rw-r--.  1 cwsop cwsop  52294154 Jan 19 09:20 IDY35050_G3_2024011818.nc</code></pre>
<h2 id="api">Api</h2>
<hr />
<p>The <code>api.cgi</code> script in Amphitrite offers web-based
functionalities to access and manage partitioned wave spectrum data.
This CGI script, written in Python, allows users to interact through
HTML and JSON formats. A detailed guide for the <code>api.cgi</code> is
here:
<a href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/docs/README_API.html" target="_blank">README_API</a></p>
<h2 id="sites-api">Sites api</h2>
<hr />
<p>A <code>sites_api.cgi</code> script is available for managing and
visualizing wave data partitions and comparing output to Ofcast active
sites. It provides various functionalities, such as comparing active
sites with configuration files, listing sites in HTML or JSON formats,
and handling site-specific data. A detailed guide for the
<code>sites_api.cgi</code> is here:
<a href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/docs/README_SITES_API.html" target="_blank">README_SITES_API</a></p>
<h2 id="installation">Installation</h2>
<hr />
<p>Python package requirements are currently met on server
<code>wa-vw-er</code> by using conda environment <code>mlenv</code>:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git@gitlab.bom.gov.au:er/innovation/amphitrite.git</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> amphitrite</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate mlenv</span></code></pre></div>
<h2 id="logging">Logging</h2>
<hr />
<p>Errors are logged to <a
href="http://wa-vw-er/webapps/er_ml_projects/davink/amphitrite/logfile.log">logfile.log</a>.
Ensure the log file is writable by the web server.</p>
<h2 id="author">Author</h2>
<hr />
<p>Daz Vink: <a
href="mailto:daz.vink@bom.gov.au">daz.vink@bom.gov.au</a></p>
</body>
</html>
